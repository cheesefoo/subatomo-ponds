<!DOCTYPE html>
<html lang="en">

<head>
    <title>Subaru Milestone Submission Form</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.js"></script>
    <script src="dropzone.bundle.js"></script>
    <link href="css/upload.css" rel="stylesheet"/>
        <link href="css/dropzone.css" rel="stylesheet"/>
</head>

<body>
<div class="contact-us" style="max-width:600px;">
    <form class="dropzone"
          action="https://script.google.com/macros/s/AKfycbwvt7E5cSBSRulXQIwn-fh-SpjUAjKE4U_0n-wEcecm5tgb7KhF0Dtuy3WW6VSMj9f9IA/exec"
          id="form" method="post">
        <div id="data">
            <div class="displayName">
                Your display name. If left blank, your name will be (TBD)
                <input id="name" maxlength="16" name="displayName">
            </div>
            <div class="email">
                <p>Can we email you if there are issues with your submission?
                <p>
                    <br>
                    Yes<input id="radioYes" name="canEmail" onclick="yesCheck();" type="radio" value="yes"><span
                        style="margin-right:20px;"></span>
                    No<input checked id="radioNo" name="canEmail" onclick="yesCheck();" type="radio" value="no">
                <div class="emailInput" id="emailInput" style="display:none">
                    <label for="email">Your email:</label>
                    <input id="email" name="email" type="email">
                </div>
            </div>
        </div>
        <div id="upload">
            <label>Upload your duck png bellow, it has to be up to the dimensions allowed in the project detailed in
                xxxxxx</label>
            <input accept="image/png" id="uploadFile" name="file" type="file">
            <input id="submit" onclick="submitting();" type="submit">
        </div>

    </form>
    <div id="submitting" style="display:none;">Uploading duck...</div>
    <canvas id="animPreview" style="visibility:hidden"></canvas>
</div>
<script>
    Dropzone.options.form = {
        paramName: "file", // The name that will be used to transfer the file
        maxFilesize: 2, // MB
        accept: function (file, done) {
            chooseFile(file)
        }
    };

    function disallowedChars(e) {
        let regex = new RegExp(escapeRegExp('<>:"/\\|?*'));
        return regex.test(e.charCode);
    }

    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // $& means the whole matched string
    }

    function yesCheck() {
        let email = document.getElementById('emailInput');
        if (document.getElementById('radioYes').checked) {
            email.style.display = 'block';
            email.required = true;

        } else {
            email.style.display = 'none';
            email.required = false;
        }
    }

    let spritesheet = new Image();

    const uploadFile = document.getElementById("uploadFile");
    uploadFile.onchange = function () {
        chooseFile(this.files[0])
    };

    function chooseFile(file) {
        const reader = new FileReader();
        // const file = this.files[0];
        if (file) {
            reader.addEventListener("load", function (e) {
                spritesheet.src = reader.result;
                canvasElement.style.visibility = "visible";
                startAnimating(10);

                //todo: check image dimensions?
            }, false);
            reader.readAsDataURL(file);
        }
    }

    let fps, fpsInterval, startTime, now, then, elapsed;

    // initialize the timer variables and start the animation
    function startAnimating(fps) {
        console.log("start animating")
        fpsInterval = 1000 / fps;
        then = Date.now();
        startTime = then;
        animate();
    }

    let w = 200;
    let h = 200;
    let sx, sy = 0;
    let scale = 1;
    let canvasElement = document.getElementById("animPreview");
    let canvasContext = canvasElement.getContext("2d");
    let canvas = canvasContext.canvas;
    let currentFrame = 1;
    const framesInAnimation = 3;
    const centerCanvas = () => {
        canvas.style.marginTop =
            `${((window.innerHeight / 2) - (canvas.height / 2))}px`;
    };

    // centerCanvas()

    function animate() {

        // request another frame

        // console.log(currentFrame);
        requestAnimationFrame(animate);

        // calc elapsed time since last loop

        now = Date.now();
        elapsed = now - then;

        // if enough time has elapsed, draw the next frame

        if (elapsed > fpsInterval) {
            then = now - (elapsed % fpsInterval);
            canvasContext.clearRect(0, 0, canvas.width, canvas.height);

            //Set corner coordinates according to current frame
            sx = currentFrame % 2 === 0 ? w : 0;
            sy = currentFrame <= 2 ? 0 : h;

            // console.log(currentFrame + ":" + sx + "x" + sy);

            canvasContext.drawImage(spritesheet, sx, sy, w, h, 0, 0, w * scale, h * scale);
            currentFrame++;
            if (currentFrame > framesInAnimation+1)
                currentFrame = 1;
        }
    }

    //$('#uploadFile').on("change", function () {
    //    try {
    //        document.getElementById('raw-sbm').remove();
    //        document.getElementById('mime-sbm').remove();
    //        document.getElementById('filetype-sbm').remove();
    //    } catch (e) {
    //    }
    //    const file = this.files[0];
    //    const fr = new FileReader();
    //    fr.fileName = file.name;
    //    fr.onload = function (e) {
    //        e.target.result
    //        html = '<input type="hidden" name="data" id="raw-sbm" value="' + e.target.result.replace(/^.*,/, '') + '" >';
    //        html += '<input type="hidden" name="mimetype" id="mime-sbm" value="' + e.target.result.match(/^.*(?=;)/)[0] + '" >';
    //        html += '<input type="hidden" name="filename" id="filename-sbm" value="' + e.target.fileName + '" >';
    //        // $("#data").empty().append(html);
    //        $("#data").append(html);
    //    }
    //    fr.readAsDataURL(file);
    //});

    function submitting() {
        $("form").hide();
        $("#submitting").show();
        try {
            document.getElementById('raw-sbm').remove();
            document.getElementById('mime-sbm').remove();
            document.getElementById('filetype-sbm').remove();
        } catch (e) {
        }

        const file = document.getElementById("uploadFile").files[0];
        const fr = new FileReader();
        fr.fileName = file.name;
        fr.onload = function (e) {
            e.target.result
            html = '<input type="hidden" name="data" id="raw-sbm" value="' + e.target.result.replace(/^.*,/, '') + '" >';
            html += '<input type="hidden" name="mimetype" id="mime-sbm" value="' + e.target.result.match(/^.*(?=;)/)[0] + '" >';
            html += '<input type="hidden" name="filename" id="filename-sbm" value="' + e.target.fileName + '" >';
            // $("#data").empty().append(html);
            $("#data").append(html);
        }
        fr.readAsDataURL(file);
    }
</script>
</body>

</html>
